---
title: "EU export and import to Russia and its neighbours"
execute:
  echo: false
format: 
    html:
        embed-resources: true
        code-fold: true
        df-print: paged
        toc: true
        toc-location: left
        theme: journal
knitr: 
  opts_chunk: 
    echo: false
    message: false
    warning: false
---

# Introduction

Russia war on Ukraine had an impact to EU and Russia trade. The goal of this document is to analyze these changes.

The analysis of overall trade impact is presented followed by the analysis of sanctioned export. The data used comes from Eurostat. See the @appendix for technical details.

## Main findings

Trade with Russia dropped significantly after Russia invasion on February 24th. However the export to Russia neighbours has increased meaning that companies are evading sanctions on exports to Russia by exporting to its neighbours instead.


```{r}
library(readxl)
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(stringr)
library(arrow)
library(DT)

source("R/read_eurostat.R")

cn <- read.csv("meta/salys.csv") %>% select(partner = country, country = name)
eu_cn <- read.csv("meta/eu_countries.csv")

eu_texp <- read_eurostat("xlsx/eu_total_trade_4630244_spreadsheet.xlsx", flow = TRUE)

eu_texp1 <- eu_texp %>%
  mutate(name = paste(flow, code, sep = "_")) %>%
  pivot_wider(id_cols = c("reporter", "partner", "month"), values_from = value, names_from = "name", values_fill = 0) %>%
  rename(
    total_export = export_TOTAL, total_import = import_TOTAL,
    energy_import = import_27, energy_export = export_27
  ) %>%
  mutate(
    export = total_export - energy_export,
    import = total_import - energy_import
  ) %>%
  left_join(cn) %>%
  inner_join(eu_cn)

eu_tr <- eu_texp1 %>% filter(month <= "2022-10-01")
```
# EU overall trade with Russia and neighbouring countries 

Energy trade is a big part of overall EU trade. It distorts overall picture so it was excluded from the analysis. The period taken is from January 2020 so that dynamics of two years before the war can be seen. The data is available up to October 2022.

## Overall trade 

### EU exports to Russia and neighbouring countries

```{r}
cols <- RColorBrewer::brewer.pal(7, "Set1")[c(5, 3, 6, 2, 4, 1, 7)]
eu_tr1 <- eu_tr %>%
  group_by(country, month) %>%
  summarise(export = sum(export), import = sum(import)) %>%
  ungroup()

ggplot(aes(x = month, y = export, fill = country), data = eu_tr1) +
  geom_col() +
  theme_bw() +
  scale_fill_manual(name = "Country", values = cols) +
  scale_y_continuous(labels = scales::dollar_format(prefix = "€")) +
  labs(x = "Month", y = "", title = "EU export to Russia and neighbouring countries")
```

### EU export to Russia neighbours

```{r}
ggplot(aes(x = month, y = export, fill = country), data = eu_tr1 %>% filter(country != "Russia")) +
  geom_col() +
  theme_bw() +
  scale_fill_manual(name = "Country", values = cols[-6]) +
  scale_y_continuous(labels = scales::dollar_format(prefix = "€")) +
  labs(x = "Month", y = "", title = "EU export to Russia neighbours")
```

### EU import from Russia and neighbouring countries

```{r}
cols <- RColorBrewer::brewer.pal(7, "Set1")[c(5, 3, 6, 2, 4, 1, 7)]
eu_tr1 <- eu_tr %>%
  group_by(country, month) %>%
  summarise(export = sum(export), import = sum(import)) %>%
  ungroup()

ggplot(aes(x = month, y = import, fill = country), data = eu_tr1) +
  geom_col() +
  theme_bw() +
  scale_fill_manual(name = "Country", values = cols) +
  scale_y_continuous(labels = scales::dollar_format(prefix = "€")) +
  labs(x = "Month", y = "", title = "EU import from Russia and neighbouring countries")
```

### EU import from Russia neighbours

```{r}
ggplot(aes(x = month, y = import, fill = country), data = eu_tr1 %>% filter(country != "Russia")) +
  geom_col() +
  theme_bw() +
  scale_fill_manual(name = "Country", values = cols[-6]) +
  scale_y_continuous(labels = scales::dollar_format(prefix = "€")) +
  labs(x = "Month", y = "", title = "EU import from Russia neighbours")
```


## Overall trade growth

Comparison is made between the months following the Russian invasion and corresponding months in 2021. 
```{r}
eu_trf <- eu_tr %>%
  mutate(
    period =
      ifelse(month >= "2021-03-01" & month <= "2021-10-01", 2021,
        ifelse(month >= "2022-03-01" & month <= "2022-10-01", 2022, NA)
      )
  ) %>%
  filter(!is.na(period)) %>%
  group_by(partner = country, reporter = eu_country, period) %>%
  summarise(export = sum(export), import = sum(import))

eu_erf <- eu_trf %>%
  filter(partner == "Russia") %>%
  arrange(reporter, period) %>%
  mutate(egrowth = round(100 * (export / lag(export) - 1), 2), igrowth = round(100 * (import / lag(import) - 1), 2))

eu_erf1 <- eu_erf %>%
  filter(period == 2022) %>%
  arrange(reporter) %>%
  mutate(epos = egrowth >= 0, ipos = igrowth >= 0) %>%
  mutate(reporter = factor(reporter, levels = sort(eu_cn$eu_country, decreasing = TRUE)))

eu_enb <- eu_trf %>%
  filter(partner != "Russia") %>%
  group_by(reporter, period) %>%
  summarise(export = sum(export), import = sum(import)) %>%
  mutate(egrowth = round(100 * (export / lag(export) - 1), 2), igrowth = round(100 * (import / lag(import) - 1), 2))

eu_enb1 <- eu_enb %>%
  filter(period == 2022) %>%
  arrange(reporter) %>%
  mutate(reporter = factor(reporter, levels = sort(eu_cn$eu_country, decreasing = TRUE))) %>%
  mutate(epos = egrowth >= 0, ipos = igrowth >= 0)
```

### EU export growth to Russia

```{r}
eu_erf2 <- eu_erf1 %>% arrange(egrowth)
eu_erf3 <- eu_erf2 %>% mutate(reporter = factor(as.character(reporter), levels = eu_erf2$reporter))

ggplot(aes(x = reporter, y = egrowth, fill = epos), data = eu_erf3) +
  geom_col() +
  coord_flip() +
  theme_bw() +
  scale_fill_manual(values = cols[c(4, 6)], guide = "none") +
  labs(y = "Export growth, %", x = "", title = "EU export to Russia in 2022 after war,  growth compared to 2021")
```

### EU export growth to Russia neighbours

```{r}
eu_enb2 <- eu_enb1 %>% arrange(egrowth)
eu_enb3 <- eu_enb2 %>% mutate(reporter = factor(as.character(reporter), levels = eu_enb2$reporter))

ggplot(aes(x = reporter, y = egrowth, fill = epos), data = eu_enb3) +
  geom_col() +
  coord_flip() +
  theme_bw() +
  scale_fill_manual(values = cols[c(4, 6)], guide = "none") +
  labs(y = "Export growth, %", x = "", title = "EU export to Russia neighbours in 2022 after war,  growth compared to 2021")
```

### EU import growth from Russia

```{r}
eu_erf4 <- eu_erf1 %>% arrange(igrowth)
eu_erf5 <- eu_erf4 %>% mutate(reporter = factor(as.character(reporter), levels = eu_erf4$reporter))


ggplot(aes(x = reporter, y = igrowth, fill = ipos), data = eu_erf5) +
  geom_col() +
  coord_flip() +
  theme_bw() +
  scale_fill_manual(values = cols[c(4, 6)], guide = "none") +
  labs(y = "Import growth, %", x = "", title = "EU import from Russia in 2022 after war, growth compared to 2021")
```

### EU import growth from Russia neighbours

```{r}
eu_enb4 <- eu_enb1 %>% arrange(igrowth)
eu_enb5 <- eu_enb4 %>% mutate(reporter = factor(as.character(reporter), levels = eu_enb4$reporter))

ggplot(aes(x = reporter, y = igrowth, fill = ipos), data = eu_enb5) +
  geom_col() +
  coord_flip() +
  theme_bw() +
  scale_fill_manual(values = cols[c(4, 6)], guide = "none") +
  labs(y = "Import growth, %", x = "", title = "EU import from Russia neighbours 2022 after war,  growth compared to 2021")
```

# Effect of sanctions on export

Sanctions put on exports are listed by their CN code in the following [document](https://eur-lex.europa.eu/legal-content/EN/TXT/?uri=CELEX%3A02014R0833-20221007). See @sec-appendix for technical details how the data was collected. The sanctions mentioned both CN 4 digits and CN 8 digits code. Only CN 8 digit codes were used for analysis.


There are quotas for certain sanctioned goods, which allow export, so it is expected that sanctioned export is non zero until the quotas run out. The effect of quotas is not analyzed.

## Export of sanctioned goods 

### To Russia with its neighbours

```{r}
espq <- read_parquet("raw/eu_export_sanctions_data.parquet")
eu_es <- espq %>%
  group_by(partner, reporter, month) %>%
  summarise(sanctioned_export = sum(value))

es1 <- eu_es %>%
  inner_join(cn) %>%
  inner_join(eu_cn)

es2 <- es1 %>%
  group_by(country, month) %>%
  summarise(sanctioned_export = sum(sanctioned_export)) %>%
  ungroup()
```



```{r}
ggplot(aes(x = month, y = sanctioned_export, fill = country), data = es2) +
  geom_col() +
  theme_bw() +
  scale_fill_manual(name = "Country", values = cols) +
  scale_y_continuous(labels = scales::dollar_format(prefix = "€")) +
  labs(x = "Month", y = "", title = "Sanctioned EU export to Russia and neighbouring countries")
```

### To Russia neighbours
```{r}
ggplot(aes(x = month, y = sanctioned_export, fill = country), data = es2 %>% filter(country != "Russia")) +
  geom_col() +
  theme_bw() +
  scale_fill_manual(name = "Country", values = cols[-6]) +
  scale_y_continuous(labels = scales::dollar_format(prefix = "€")) +
  labs(x = "Month", y = "", title = "Sanctioned EU export to Russia neighbours")
```
## Sanctioned export growth


```{r}
eu_strf <- es1 %>%
  mutate(
    period =
      ifelse(month >= "2021-03-01" & month <= "2021-10-01", 2021,
        ifelse(month >= "2022-03-01" & month <= "2022-10-01", 2022, NA)
      )
  ) %>%
  filter(!is.na(period)) %>%
  group_by(partner = country, reporter = eu_country, period) %>%
  summarise(sanctioned_export = sum(sanctioned_export))

eu_serf <- eu_strf %>%
  filter(partner == "Russia") %>%
  arrange(reporter, period) %>%
  mutate(egrowth = round(100 * (sanctioned_export / lag(sanctioned_export) - 1), 2))

eu_serf1 <- eu_serf %>%
  filter(period == 2022) %>%
  arrange(reporter) %>%
  mutate(epos = egrowth >= 0) %>%
  mutate(reporter = factor(reporter, levels = sort(eu_cn$eu_country, decreasing = TRUE)))

eu_senb <- eu_strf %>%
  filter(partner != "Russia") %>%
  group_by(reporter, period) %>%
  summarise(sanctioned_export = sum(sanctioned_export)) %>%
  mutate(egrowth = round(100 * (sanctioned_export / lag(sanctioned_export) - 1), 2))

eu_senb1 <- eu_senb %>%
  filter(period == 2022) %>%
  arrange(reporter) %>%
  mutate(reporter = factor(reporter, levels = sort(eu_cn$eu_country, decreasing = TRUE))) %>%
  mutate(epos = egrowth >= 0)
```

### EU sanctioned export growth to Russia

```{r}
eu_serf2 <- eu_serf1 %>% arrange(egrowth)
eu_serf3 <- eu_serf2 %>% mutate(reporter = factor(as.character(reporter), levels = eu_serf2$reporter))

ggplot(aes(x = reporter, y = egrowth, fill = epos), data = eu_serf3) +
  geom_col() +
  coord_flip() +
  theme_bw() +
  scale_fill_manual(values = cols[c(4, 6)], guide = "none") +
  labs(y = "Export growth, %", x = "", title = "EU sanctioned export growth to Russia in 2022 after war")
```

### EU sanctioned export growth to Russia neighbours

```{r}
eu_senb2 <- eu_senb1 %>% arrange(egrowth)
eu_senb3 <- eu_senb2 %>% mutate(reporter = factor(as.character(reporter), levels = eu_senb2$reporter))

ggplot(aes(x = reporter, y = egrowth, fill = epos), data = eu_senb3) +
  geom_col() +
  coord_flip() +
  theme_bw() +
  scale_fill_manual(values = cols[c(4, 6)], guide = "none") +
  labs(y = "Export growth, %", x = "", title = "EU sanctioned export growth to Russia neighbours after war")
```

```{r}
scd <- espq %>%
  count(code, product) %>%
  select(-n) %>%
  mutate(head = substring(code, 1, 4))

espq1 <- espq %>%
  mutate(
    period =
      ifelse(month >= "2021-03-01" & month <= "2021-10-01", 2021,
        ifelse(month >= "2022-03-01" & month <= "2022-10-01", 2022, NA)
      )
  ) %>%
  inner_join(cn) %>%
  inner_join(eu_cn) %>%
  filter(!is.na(period)) %>%
  group_by(partner = country, reporter = eu_country, period, code, product) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  arrange(partner, reporter, code, product, period) %>%
  group_by(partner, reporter, code, product) %>%
  mutate(egrowth = round(100 * (value / lag(value) - 1), 2)) %>%
  ungroup()

espq2 <- espq1 %>%
  mutate(head = substring(code, 1, 4)) %>%
  group_by(partner, reporter, period, head) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  arrange(partner, reporter, head, period) %>%
  group_by(partner, reporter, head) %>%
  mutate(egrowth = round(100 * (value / lag(value) - 1), 2))

espq3 <- espq1 %>%
  group_by(partner, period, code, product) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  arrange(partner, code, product, period) %>%
  group_by(partner, code, product) %>%
  mutate(egrowth = round(100 * (value / lag(value) - 1), 2)) %>%
  ungroup()

espq4 <- espq1 %>%
  group_by(reporter, period, code, product) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  arrange(reporter, code, product, period) %>%
  group_by(reporter, code, product) %>%
  mutate(egrowth = round(100 * (value / lag(value) - 1), 2)) %>%
  ungroup()

espq5 <- espq1 %>%
  group_by(reporter, period) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  arrange(reporter, period) %>%
  group_by(reporter) %>%
  mutate(egrowth = round(100 * (value / lag(value) - 1), 2)) %>%
  ungroup()
```

### EU sanctioned export 

Absolute values Russian and its neighbours combined.

```{r}
es_set <- espq5 %>%
  filter(period == 2022) %>%
  arrange(value)
es_set1 <- es_set %>% mutate(reporter = factor(reporter, levels = es_set$reporter))

ggplot(aes(x = reporter, y = value), data = es_set1 %>% mutate(value = value / 1e6)) +
  geom_col() +
  coord_flip() +
  theme_bw() +
  labs(y = "Export, millions €", x = "", title = "EU sanctioned export, after start of war")
```


```{r}
es_seg <- espq5 %>%
  filter(period == 2022) %>%
  arrange(egrowth) %>%
  mutate(epos = egrowth > 0)
es_seg1 <- es_seg %>% mutate(reporter = factor(reporter, levels = es_seg$reporter))

ggplot(aes(x = reporter, y = egrowth, fill = epos), data = es_seg1 %>% mutate(value = value / 1e6)) +
  geom_col() +
  coord_flip() +
  theme_bw() +
  scale_fill_manual(values = cols[c(4, 6)], guide = "none") +
  labs(y = "Export, growth %", x = "", title = "EU sanctioned export growth, after start of war")
```

## Sanction anomalies

Export to Russia sanction evasion should be visible by increased export to other countries. Define anomaly as the export which is more than 10 million euro in value and which doubled after a war.

```{r}
tb <- espq1 %>%
  filter(period == 2022) %>%
  filter(value > 10e6 & egrowth > 100) %>%
  mutate(growth = egrowth / 100) %>%
  arrange(-value) %>%
  select(reporter, partner, code, product, value, growth)


datatable(tb,
  options =
    list(
      dom = "lpt",
      pageLength = 10,
      lengthMenu = c(10, 50, nrow(tb)),
      columnDefs = list(list(
        targets = "_all",
        render = JS(
          "function(data, type, row, meta) {",
          "return type === 'display' && data != null && data.length > 30 ?",
          "'<span title=\"' + data + '\">' + data.substr(0, 30) + '...</span>' : data;",
          "}"
        )
      ))
    ),
  class = "display", rownames = FALSE
) %>%
  formatCurrency(c("value"), currency = "€") %>%
  formatPercentage(c("growth"), 2)
``` 

# Appendix {#sec-appendix}

## Data

The data used comes from Eurostat dataset on internation trade in [goods](https://ec.europa.eu/eurostat/databrowser/view/DS-045409/legacyMultiFreq/table?lang=en). 

All the code and data resides in the [Github repository](https://github.com/vzemlys/ruimpeks/):

1. [Code for this document](https://github.com/vzemlys/ruimpeks/eu_ru_export.qmd)  
2. [Total trade data](https://github.com/vzemlys/ruimpeks/xlsx) 
3. [CN codes for export sanctions](https://github.com/vzemlys/ruimpeks/raw/input_codes.csv)
4. [Sanctioned export data](https://github.com/vzemlys/ruimpeks/raw) and the [code to prepare it](https://github.com/vzemlys/ruimpeks/R/prepare_data.R).
5. [Sanctioned exports CN 8 digits codes](https://github.com/vzemlys/ruimpeks/raw) and the [code to prepare it](https://github.com/vzemlys/ruimpeks/meta/export_sanction_codes.csv).
